name: Migrate All Tables to D1

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      setup_schema:
        description: 'Setup D1 schema before migration'
        required: false
        type: boolean
        default: false

  # Optional: Schedule automatic migration (uncomment to enable)
  # schedule:
  #   - cron: '0 2 * * 0'  # Run every Sunday at 02:00 UTC

jobs:
  migrate-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Cloudflare credentials
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: npm run validate

      - name: Setup D1 Schema (optional)
        if: github.event.inputs.setup_schema == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: npm run setup-db

      - name: Migrate coordinate_speed_new table
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          BATCH_SIZE: ${{ vars.BATCH_SIZE || '50' }}
        run: |
          echo "ðŸ“Š Starting migration: coordinate_speed_new"
          npm run migrate

      - name: Migrate camera_locations table
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          BATCH_SIZE: ${{ vars.BATCH_SIZE || '50' }}
        run: |
          echo "ðŸ“Š Starting migration: camera_locations"
          npm run migrate:camera

      - name: Migration Summary
        if: always()
        run: |
          echo "## All Tables Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All migrations workflow completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- D1 Database ID: \`${{ secrets.D1_DATABASE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Batch Size: \`${{ vars.BATCH_SIZE || '50' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Batch size is automatically capped based on SQLite variable limits." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tables Migrated:**" >> $GITHUB_STEP_SUMMARY
          echo "1. coordinate_speed_new" >> $GITHUB_STEP_SUMMARY
          echo "2. camera_locations" >> $GITHUB_STEP_SUMMARY
